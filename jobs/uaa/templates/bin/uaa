#!/bin/bash

set -e

source "/var/vcap/jobs/uaa/bin/configure_proxy"
source "/var/vcap/jobs/uaa/bin/configure_newrelic"


if [[ -f /var/vcap/jobs/uaa/config/cacerts ]]; then
  KEYSTORE="/var/vcap/jobs/uaa/config/cacerts"
else
  KEYSTORE="/var/vcap/packages/uaa/jdk/jre/lib/security/cacerts"
fi

KEYSTORE_OPTS="-Djavax.net.ssl.trustStore=$KEYSTORE -Djavax.net.ssl.trustStoreType=JKS"
echo "[uaa-start] Keystore configured to: $KEYSTORE"

export PATH="/var/vcap/packages/uaa/jdk/bin:$PATH"
export JAVA_OPTS="-DPID=$$ -Dnetworkaddress.cache.ttl=0 $HTTP_PROXY_JAVA_OPTIONS $NEWRELIC_OPTS $KEYSTORE_OPTS"

echo "`date` [uaa-start] Calling Tomcat start up command"
/var/vcap/packages/uaa/tomcat/bin/catalina.sh run &
CATALINA_PID=$!
echo "`date` [uaa-start] uaa/tomcat started in background. Waiting for signals"
wait "${CATALINA_PID}"
EXIT_STATUS=$?
echo "`date` [uaa-start] uaa/tomcat job exiting."
exit $EXIT_STATUS
